apiVersion: connectivity.iotoperations.azure.com/v1
kind: DataflowEndpoint
metadata:
  name: eventgrid-target
  namespace: default
spec:
  endpointType: mqtt
  mqttSettings:
    host: $EVENTGRID_MQTT_DOMAIN
    tls:
      mode: Enabled
    authentication:
      method: UserAssignedManagedIdentity
      userAssignedManagedIdentitySettings:
        clientId: $MANAGED_IDENTITY_CLIENT_ID
        tenantId: 72f988bf-86f1-41af-91ab-2d7cd011db47
---
apiVersion: connectivity.iotoperations.azure.com/v1
kind: DataflowEndpoint
metadata:
  name: mq-source
  namespace: default
spec:
  endpointType: mqtt
  mqttSettings:
    host: "aio-broker:8883"
    tls:
      mode: Enabled
      trustedCaCertificateConfigMapRef: aio-broker-ca
    maxInflightMessages: 10000
    authentication:
      method: ServiceAccountToken
      serviceAccountTokenSettings:
        audience: aio-mq-internal
---
apiVersion: connectivity.iotoperations.azure.com/v1
kind: Dataflow
metadata:
  name: mq-eventgrid
  namespace: default
spec:
  profileRef: mq-offline-flow
  operations:
    - operationType: source
      sourceSettings:
        endpointRef: mq-source
        dataSources:
        - source
    - operationType: destination
      destinationSettings:
        endpointRef: eventgrid-target
        dataDestination: $EVENTGRID_TOPIC_NAME
---
apiVersion: connectivity.iotoperations.azure.com/v1
kind: DataflowEndpoint
metadata:
  name: kafka-target
  namespace: default
spec:
  endpointType: kafka
  kafkaSettings:
    copyMqttProperties: Enabled
    cloudEventAttributes: CreateOrRemap
    host: $EVENTHUB_KAFKA_DOMAIN
    tls:
      mode: Enabled
    authentication:
      method: Sasl
      saslSettings:
        saslType: plain
        secretRef: "eh-secret"
---
apiVersion: connectivity.iotoperations.azure.com/v1
kind: Dataflow
metadata:
  name: mq-to-kafka
  namespace: default
spec:
  profileRef: mq-offline-flow
  operations:
    - operationType: source
      sourceSettings:
        endpointRef: mq-source
        dataSources:
        - source/#
    - operationType: destination
      destinationSettings:
        endpointRef: kafka-target
        dataDestination: $EVENTHUB_NAME
---
apiVersion: connectivity.iotoperations.azure.com/v1
kind: DataflowEndpoint
metadata:
  name: fabric-target
  namespace: default
spec:
  endpointType: fabricOneLake
  fabricOneLakeSettings:
    host: "https://msit-onelake.dfs.fabric.microsoft.com"
    oneLakePathType: Tables
    names:
      lakehouseName: nbcofflinelakehouse
      workspaceName: nbc-offline
    batching:
      latencySeconds: 10
      maxMessages: 10000
    authentication:
      method: UserAssignedManagedIdentity
      userAssignedManagedIdentitySettings:
        clientId: 8213606c-7620-4453-add8-c1b8f2e53503
        tenantId: 72f988bf-86f1-41af-91ab-2d7cd011db47
---
apiVersion: connectivity.iotoperations.azure.com/v1
kind: Dataflow
metadata:
  name: mq-to-fabric
  namespace: default
spec:
  profileRef: mq-offline-flow
  operations:
    - operationType: source
      sourceSettings:
        endpointRef: mq-source
        dataSources:
        - source
    - operationType: builtInTransformation
      builtInTransformationSettings:
        map:
        - inputs:
          - value
          output: value
        schemaRef: "dss://parquet.json"
        serializationFormat: "Delta"
    - operationType: destination
      destinationSettings:
        endpointRef: fabric-target
        dataDestination: dest
---
apiVersion: connectivity.iotoperations.azure.com/v1
kind: DataflowEndpoint
metadata:
  name: datalake-target
  namespace: default
spec:
  endpointType: dataLakeStorage
  dataLakeStorageSettings:
    host: "https://$STORAGE_ACCOUNT_NAME.blob.core.windows.net/"
    batching:
      latencySeconds: 0
      maxMessages: 100
    authentication:
      method: UserAssignedManagedIdentity
      userAssignedManagedIdentitySettings:
        clientId: $MANAGED_IDENTITY_CLIENT_ID
        tenantId: 72f988bf-86f1-41af-91ab-2d7cd011db47
---
apiVersion: connectivity.iotoperations.azure.com/v1
kind: Dataflow
metadata:
  name: mq-to-datalake
  namespace: default
spec:
  profileRef: mq-offline-flow
  operations:
    - operationType: source
      sourceSettings:
        endpointRef: mq-source
        dataSources:
        - source
    - operationType: builtInTransformation
      builtInTransformationSettings:
        map:
        - inputs:
          - value
          output: value
        schemaRef: "dss://parquet.json"
        serializationFormat: "Delta"
    - operationType: destination
      destinationSettings:
        endpointRef: datalake-target
        dataDestination: $STORAGE_CONTAINER_NAME
---
apiVersion: connectivity.iotoperations.azure.com/v1
kind: DataflowProfile
metadata:
  name: mq-offline-flow
  namespace: default
spec:
  instanceCount: 1
  diagnostics:
    logs:
      level: "info"